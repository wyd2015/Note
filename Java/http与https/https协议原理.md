# Https原理
## 一、加密方法
HTTPS采用共享密钥加密和公开密钥加密两者并用的混合加密机制。如果仅仅保证密钥的安全性，使用公开密钥加密方式即可，但公开密钥加密方式比共享密钥加密的处理速度要慢。所以`HTTPS在交换密钥环节采用公开密钥加密方式，之后在建立通信交换报文阶段采用共享密钥加密方式进行加密`。
### 1. 对称密钥加密：  
加密和解密同用一个密钥，以共享密钥方式的加密必须将密钥也发送给对方，在网络上发送密钥很容易被攻击者获取，并且服务器如果对所有客户端都使用同样的共享密钥，等同于没有加密。所以，https采用生成的`随机数`来作为共享加密算法的密钥。

### 2. 公开密钥加密： 
使用一对`非对称的密钥`，一把叫`私有密钥`，一把叫`公钥密钥`，发送密文的一方使用对方的公开密钥进行加密，接收方接到加密信息后，使用自己的私有密钥进行解密，这样就不用担心密钥被攻击者获取。

[【注意】](#)：公开密钥加密方式也不能保证公开密钥本身的真实性，比如在于某台服务器建立连接时，无法保证接收到的公开密钥就是所需要连接的那台服务器密钥，此时可以采用`数字证书认证机构和其相关机关颁发的公开密钥证书`。

## 二、 HTTPS握手过程
1. 首先，客户端会发送一个https请求，把自身支持的一系列密钥算法组件(Cipher Suite)发送给服务器；
2. 服务器接收到客户端所有的Clipher后与自身支持的进行对比，如果不支持则断开连接，反之会从中选择一种加密算法和HASH算法以证书的形式返回给客户端，证书中包含了加密公钥、颁证机构、网站地址、失效日期等；
3. 客户端接收到服务器端的响应后会做一下几件事：  
    （1）验证证书的合法性，颁发证书的机构是否合法、是否已过期，证书中包含的网站地址是否与正在访问的地址一致等，证书验证通过后，在浏览器的地址栏会加上一把小锁；  
    （2）证书验证通过后，生成随机密码，用证书中的公钥加密；
    （3）使用约定好的HASH计算握手信息，并使用生成的随机数密码对消息进行加密，最后将之前生成的所有消息发送给网站；  
    （4）服务器接收到客户端传来的密文，用自己的私钥解密取出随机数密码，然后用随机数密码解密浏览器发送过来的握手消息，并验证HASH是否与浏览器发来的一致，然后使用密码加密一段握手信息，发送给浏览器；  
    （5）客户端使用随机数密码解密、计算出握手消息的HASH值，如果与服务器发来的HASH一致，握手过程结束。  
在此之后的所有通信数据将由之前浏览器生成的随机数密码，并利用`对称加密算法`用于对真正传输的数据进行加密，而Hash算法用于验证数据的完整性。  
如果TLS握手过程中有任何错误，都会使加密连接断开，从而阻止隐私信息的传输，由于https非常安全，攻击者无法从中找到下手地方，于是更多采用`假证书`的手法欺骗客户端，从而获取明文的信息。

## 三、HTTPS攻击手段
浏览器在对证书进行验证时，以下几种情况会导致验证失败：  
- SSL证书不是由受信任的CA机构颁发的；
- 证书过期；
- 访问的网站域名与证书绑定的域名不一致。  

https常见的攻击手段：  
`SSL证书欺骗（SSL劫持）`：一种典型的中间人攻击，不过SSL劫持并非只是用于攻击目的，在一些特殊情况下利用SSL劫持可以更顺畅的访问网络。  
>SSL劫持需要将攻击者接入到浏览器与目标网站之间，在传输数据过程中，替换目标网站发给浏览器的证书，之后解密传输的数据，中间人攻击最好的环境是在局域网中。局域网所有计算机需要通过网关接入互联网，攻击者只需实施一次中间人攻击就可以顺利截获所有计算机与网关之间传输的数据。  

对于一般的SSL劫持，浏览器会给出证书错误的提示，如果继续访问，所有加密的数据都可以被攻击者解密。

`SSLStrip攻击`：需要将攻击者设置为中间人，之后将HTTPS访问代替为HTTP返回给浏览器，由于HTTP协议传输的数据都是为加密的，从而截获用户访问的数据。对于用户的登录账号、密码等信息，可以在发送之前用javascript进行一次加密处理，这种方法对`SSLStrip`和`SSL`劫持都是有效的。

HTTPS也存在一些问题：处理速度会变慢，一是由于存在HTTPS握手环节，导致通信变慢；二是由于存在传输信息加密处理，消耗CPU及内存资源，这对高并发的服务器而言更是一种瓶颈。so，`服务器只对含有敏感信息的数据进行加密`。